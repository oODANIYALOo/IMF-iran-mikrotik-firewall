#!/bin/bash

INVENTORY_FILE="inventory.ini"
HOST_PREFIX="mikrotik"

show_help() {
    echo "Usage: $0 [command] [options]"
    echo "Commands:"
    echo "  add <ip> <user> <pass>   - Add a new host"
    echo "  del <number|ip>          - Delete host by number or IP"
    echo "  show                     - Show all hosts"
    echo ""
    echo "Example:"
    echo "  $0 add 192.88.1.1 admin password123"
    echo "  $0 del 1"
    echo "  $0 del 192.88.1.1"
    echo "  $0 show"
}

if [ ! -f "$INVENTORY_FILE" ]; then
    cat > "$INVENTORY_FILE" << EOF
[allmikrotik]
# dont modify this file 
# automaticly created and modify with IMF

EOF
fi

add_host() {
    if [ $# -ne 3 ]; then
        echo "Error: add command requires 3 arguments: ip user pass"
        echo "Usage: $0 add <ip> <user> <pass>"
        exit 1
    elif ! [[ "$1" =~ ^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$ ]]; then
        echo "Error: ip incorrect"
        echo "example: 10.20.30.1, 192.168.1.100"
        exit 1
  elif ! [[ "$2" =~ ^[a-z,A-Z,0-9]{3,32}$ ]]; then
        echo "Error: user incorrect"
        exit 1
  elif ! [[ $3 =~ ^[a-z,A-Z,0-9]{1,50}$ ]]; then
        echo "Error: pass incorrect"
        exit 1
    fi
    
    local ip="$1"
    local user="$2"
    local pass="$3"
    
    if grep -q "ansible_host=$ip" "$INVENTORY_FILE"; then
        echo "Error: Host with IP $ip already exists!"
        exit 1
    fi
    
    local last_num=$(grep -o "${HOST_PREFIX}[0-9]*" "$INVENTORY_FILE" | grep -o "[0-9]*" | sort -n | tail -1)
    if [ -z "$last_num" ]; then
        last_num=0
    fi
    
    local next_num=$((last_num + 1))
    local hostname="${HOST_PREFIX}${next_num}"
    
    cat >> "$INVENTORY_FILE" << EOF
$hostname ansible_host=$ip ansible_user=$user ansible_ssh_pass=$pass ansible_connection=ansible.netcommon.network_cli ansible_network_os=community.routeros.routeros ansible_become=yes ansible_become_method=enable

EOF
    
    echo "Host $hostname added successfully with IP: $ip"
    echo "You can now run: $0 ansible"
}

show_hosts() {
    
    local line_num=1
    while IFS= read -r line; do
        if [[ "$line" =~ ^${HOST_PREFIX}[0-9]+ ]]; then
            local hostname=$(echo "$line" | awk '{print $1}')
            local ip=$(echo "$line" | grep -o 'ansible_host=[^ ]*' | cut -d= -f2)
            local user=$(echo "$line" | grep -o 'ansible_user=[^ ]*' | cut -d= -f2)
            
            echo "$line_num) $hostname"
            echo "   IP: $ip"
            echo "   User: $user"
            echo ""
            ((line_num++))
        fi
    done < "$INVENTORY_FILE"
    
    if [ $line_num -eq 1 ]; then
        echo "No hosts found in inventory."
    fi
}

delete_host() {
    if [ $# -ne 1 ]; then
        echo "Error: del command requires 1 argument: number or IP"
        echo "Usage: $0 del <number|ip>"
        exit 1
    fi
    
    local target="$1"
    
    if [[ "$target" =~ ^[0-9]+$ ]]; then
        local line_num=1
        local found_line=""
        
        while IFS= read -r line; do
            if [[ "$line" =~ ^${HOST_PREFIX}[0-9]+ ]]; then
                if [ $line_num -eq $target ]; then
                    found_line="$line"
                    break
                fi
                ((line_num++))
            fi
        done < "$INVENTORY_FILE"
        
        if [ -z "$found_line" ]; then
            echo "Error: No host found with number $target"
            exit 1
        fi
        
        local temp_file="${INVENTORY_FILE}.tmp"
        grep -v "^${found_line}$" "$INVENTORY_FILE" > "$temp_file"
        mv "$temp_file" "$INVENTORY_FILE"
        
        echo "Host number $target deleted successfully"
        
    else
        if ! grep -q "ansible_host=$target" "$INVENTORY_FILE"; then
            echo "Error: No host found with IP $target"
            exit 1
        fi
        
        local temp_file="${INVENTORY_FILE}.tmp"
        grep -v "ansible_host=$target" "$INVENTORY_FILE" > "$temp_file"
        mv "$temp_file" "$INVENTORY_FILE"
        
        echo "Host with IP $target deleted successfully"
    fi
}

run_ansible() {
    if ! grep -q "^${HOST_PREFIX}[0-9]" "$INVENTORY_FILE"; then
        echo "Error: No mikrotik hosts found in inventory!"
        echo "Add hosts first using: $0 add <ip> <user> <pass>"
        exit 1
    fi
    
    echo "Running ansible on all mikrotik hosts..."
    echo ""
    
    ansible allmikrotik -i "$INVENTORY_FILE" -m ping
}

case "$1" in
    add)
        shift
        add_host "$@"
        ;;
    del)
        shift
        delete_host "$@"
        ;;
    show)
        show_hosts
        ;;
    ansible)
        # dont use this command just for test
        if [ -n "$2" ]; then
            shift
            ansible allmikrotik -i "$INVENTORY_FILE" "$@"
        else
            run_ansible
        fi
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Error: this argument not found '$1' --- IMF-ADD-ERROR"
        echo ""
        show_help
        exit 1
        ;;
esac
