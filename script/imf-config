#!/bin/bash

SCRIPT_NAME="imf-config"


# Show help
show_help() {
    cat << EOF
Usage: $SCRIPT_NAME [options]

Main options:
  --hostname name           Set hostname (required)
  --dhcp-server             Add DHCP Server
  --vlan                    Add VLAN configuration
  --firewall                Add Simple Firewall
  --harden                  Add Simple Harden
  --add-route               Add Static Route
  --set-ntp                 Set NTP Server

Advanced options:
  dhcp-server
  --dhcp-pool address       DHCP Pool range (default: 192.168.1.100-192.168.1.200)
  --dhcp-network network    DHCP Network (default: 192.168.1.0/24)
  vlan
  --vlan-id number          VLAN ID (default: 10)
  --vlan-interface iface    VLAN Interface (default: ether1)
  add route
  --route-dest destination  Route Destination (default: 10.0.0.0/8)
  --route-gateway gateway   Route Gateway (default: 192.168.1.254)
  set ntp
  --ntp-server server       NTP Server (default: pool.ntp.org)

General options:
  --output-file filename    Output filename (default: mikrotik-config.yml)
  --help                    Show this help message

Examples:
  $SCRIPT_NAME --hostname router1 --dhcp-server --dhcp-pool "192.168.10.50-192.168.10.150"
  $SCRIPT_NAME --hostname router1 --vlan --vlan-id 20 --vlan-interface ether2
EOF
    exit 0
}

declare -A CONFIG=(
    [HEADER]="false"
    [HOSTNAME]="false"
    [HOST_NAME]=""
    [DHCP_SERVER]="false"
    [DHCP_POOL]="192.168.1.100-192.168.1.200"
    [DHCP_NETWORK]="192.168.1.0/24"
    [VLAN]="false"
    [VLAN_ID]="10"
    [VLAN_INTERFACE]="ether1"
    [FIREWALL]="false"
    [HARDEN]="false"
    [ADD_ROUTE]="false"
    [ROUTE_DEST]="10.0.0.0/8"
    [ROUTE_GATEWAY]="192.168.1.254"
    [SET_NTP]="false"
    [NTP_SERVER]="pool.ntp.org"
    [OUTPUT_FILE]="mikrotik-config.yml"
)



# all config
playbook_header() {
    cat > "${CONFIG[OUTPUT_FILE]}" << "EOF"
---
- name: Configure MikroTik Router
  hosts: mikrotik
  gather_facts: no
  connection: ansible.netcommon.network_cli

  vars:
    ansible_network_os: community.routeros.routeros
    
  tasks:
EOF
}

hostname_task() {
    cat >> "${CONFIG[OUTPUT_FILE]}" << EOF
    - name: Set hostname to ${CONFIG[HOST_NAME]}
      community.routeros.command:
        commands:
          - /system identity set name=${CONFIG[HOST_NAME]}

EOF
}

create_yaml() {

	if [ "${CONFIG[HEADER]}" = "true" ]; then
		playbook_header
	fi

	if [ "${CONFIG[HOSTNAME]}" = "true" ]; then
		hostname_task
	fi
}

arguments() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --header)
                CONFIG[HEADER]="true"
                shift
                ;;
            --hostname)
                CONFIG[HOSTNAME]="true"
                CONFIG[HOST_NAME]="$2"
                shift 2
                ;;
            --dhcp-server)
                CONFIG[DHCP_SERVER]="true"
                shift
                ;;
            --dhcp-pool)
                CONFIG[DHCP_POOL]="$2"
                shift 2
                ;;
            --dhcp-network)
                CONFIG[DHCP_NETWORK]="$2"
                shift 2
                ;;
            --vlan)
                CONFIG[VLAN]="true"
                shift
                ;;
            --vlan-id)
                CONFIG[VLAN_ID]="$2"
                shift 2
                ;;
            --vlan-interface)
                CONFIG[VLAN_INTERFACE]="$2"
                shift 2
                ;;
            --firewall)
                CONFIG[FIREWALL]="true"
                shift
                ;;
            --harden)
                CONFIG[HARDEN]="true"
                shift
                ;;
            --add-route)
                CONFIG[ADD_ROUTE]="true"
                shift
                ;;
            --route-dest)
                CONFIG[ROUTE_DEST]="$2"
                shift 2
                ;;
            --route-gateway)
                CONFIG[ROUTE_GATEWAY]="$2"
                shift 2
                ;;
            --set-ntp)
                CONFIG[SET_NTP]="true"
                shift
                ;;
            --ntp-server)
                CONFIG[NTP_SERVER]="$2"
                shift 2
                ;;
            --output-file)
                CONFIG[OUTPUT_FILE]="$2"
                shift 2
                ;;
            --help)
                show_help
                ;;
            *)
                echo "argument error: not found : $1"
                show_help
                exit 1
                ;;
        esac
    done
}


main() {
    # Parse arguments
    arguments "$@"
    
    
    # Create configuration
    if create_yaml; then
        echo "âœ… Configuration file successfully created!"
        echo ""
        echo "ðŸ“ Usage:"
        echo "ansible-playbook -i inventory.ini ${CONFIG[OUTPUT_FILE]}"
        echo ""
        echo "ðŸ”§ Sample inventory.ini:"
        cat << EOF
[mikrotik]
router.local ansible_host=192.168.88.1 ansible_user=admin ansible_password=admin ansible_connection=ansible.netcommon.network_cli

[all:vars]
ansible_network_os=community.routeros.routeros
EOF
        echo ""
        echo "âš ï¸  Notes:"
        echo "  - Change admin password in inventory before execution"
        echo "  - Adjust IP address to match your actual router"
        echo "  - Ensure community.routeros collection is installed"
    else
        echo "âŒ Error creating configuration file"
        exit 1
    fi
}


if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    if [ $# -eq 0 ]; then
        show_help
    else
        main "$@"
    fi
fi
