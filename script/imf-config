#!/bin/bash

SCRIPT_NAME="imf-config"


# Show help
show_help() {
    cat << EOF
Usage: $SCRIPT_NAME [options]

Main options:
  --header		    (important) for create header file - use for create yaml file
  --file-config FILE	    adding file configuration
  --hostname NAME           Set hostname (required)
  --dhcp-server             Add DHCP Server
  --vlan                    Add VLAN configuration
  --firewall                Add Simple Firewall
  --harden                  Add Simple Harden
  --add-route               Add Static Route
  --set-ntp                 Set NTP Server

Advanced options:
  dhcp-server
  --dhcp-pool address       DHCP Pool range (default: 192.168.1.100-192.168.1.200)
  --dhcp-network network    DHCP Network (default: 192.168.1.0/24)
  vlan
  --vlan-id number          VLAN ID (default: 10)
  --vlan-interface iface    VLAN Interface (default: ether1)
  add route
  --route-dest destination  Route Destination (default: 10.0.0.0/8)
  --route-gateway gateway   Route Gateway (default: 192.168.1.254)
  set ntp
  --ntp-server server       NTP Server (default: pool.ntp.org)

General options:
  --output-file filename    Output filename (default: mikrotik-config.yml)
  --help                    Show this help message

Examples:
  $SCRIPT_NAME --header --file-config FILE
  $SCRIPT_NAME --hostname NAME 
  $SCRIPT_NAME --hostname router1 --dhcp-server --dhcp-pool "192.168.10.50-192.168.10.150"
  $SCRIPT_NAME --hostname router1 --vlan --vlan-id 20 --vlan-interface ether2
EOF
    exit 0
}

declare -A CONFIG=(
    [HEADER]="false"
    [FILECONFIG]="false"
    [FILE_CONFIG]=""
    [HOSTNAME]="false"
    [HOST_NAME]=""
    [DHCP_SERVER]="false"
    [DHCP_POOL]="192.168.1.100-192.168.1.200"
    [DHCP_NETWORK]="192.168.1.0/24"
    [VLAN]="false"
    [VLAN_ID]="10"
    [VLAN_INTERFACE]="ether1"
    [FIREWALL]="false"
    [HARDEN]="false"
    [ADD_ROUTE]="false"
    [ROUTE_DEST]="10.0.0.0/8"
    [ROUTE_GATEWAY]="192.168.1.254"
    [SET_NTP]="false"
    [NTP_SERVER]="pool.ntp.org"
    [OUTPUT_FILE]="mikrotik-config.yml"
    [IMF_CONFIG_LOG]=".imf-config.log"
)



# all config
playbook_header() {
    cat > "${CONFIG[OUTPUT_FILE]}" << "EOF"
---
- name: Configure MikroTik Router
  hosts: allmikrotik
  gather_facts: no
  connection: ansible.netcommon.network_cli

  vars:
    ansible_network_os: community.routeros.routeros
    
  tasks:
EOF
}

file_config() {
    cat >> "${CONFIG[OUTPUT_FILE]}" << EOF
    - name: User config file
      community.routeros.command:
        commands:
EOF
sed -i 's/^/          - /' "${CONFIG[FILE_CONFIG]}"
cat "${CONFIG[FILE_CONFIG]}" >> "${CONFIG[OUTPUT_FILE]}"
}

hostname_task() {
    cat >> "${CONFIG[OUTPUT_FILE]}" << EOF
    - name: Set hostname to ${CONFIG[HOST_NAME]}
      community.routeros.command:
        commands:
          - /system identity set name=${CONFIG[HOST_NAME]}

EOF
}

dhcp_server_task() {
    cat >> "$TASKS_FILE" << EOF
    - name: Configure DHCP Server
      community.routeros.command:
        commands:
          - /ip pool add name=dhcp_pool ranges=${CONFIG[DHCP_POOL]}
          - /ip dhcp-server network add address=${CONFIG[DHCP_NETWORK]} gateway=\${split("${CONFIG[DHCP_NETWORK]}", "/")[0]%.*}.1
          - /ip dhcp-server add name=dhcp1 interface=bridge-local disabled=no address-pool=dhcp_pool

EOF
}

vlan_task() {
    cat >> "$TASKS_FILE" << EOF
    - name: Configure VLAN ${CONFIG[VLAN_ID]} on ${CONFIG[VLAN_INTERFACE]}
      community.routeros.command:
        commands:
          - /interface vlan add name=vlan${CONFIG[VLAN_ID]} interface=${CONFIG[VLAN_INTERFACE]} vlan-id=${CONFIG[VLAN_ID]}
          - /ip address add address=10.0.${CONFIG[VLAN_ID]}.1/24 interface=vlan${CONFIG[VLAN_ID]}

EOF
}

firewall_task() {
    cat >> "$TASKS_FILE" << EOF
    - name: Configure Simple Firewall Rules
      community.routeros.command:
        commands:
          - /ip firewall filter
          - add chain=input action=accept protocol=tcp dst-port=22 comment="Allow SSH"
          - add chain=input action=accept protocol=icmp comment="Allow ICMP"
          - add chain=input action=accept protocol=udp dst-port=53 comment="Allow DNS"
          - add chain=input action=accept protocol=udp dst-port=67-68 comment="Allow DHCP"
          - add chain=input action=drop in-interface=!lan comment="Drop everything else not from LAN"
          - add chain=forward action=fasttrack-connection connection-state=established,related comment="FastTrack"
          - add chain=forward action=accept connection-state=established,related
          - add chain=forward action=drop connection-state=invalid
          - add chain=forward action=drop connection-state=new connection-nat-state=!dstnat in-interface=wan
          - add chain=forward action=accept out-interface=wan comment="Allow outgoing traffic"

EOF
}

harden_task() {
    cat >> "$TASKS_FILE" << EOF
    - name: Configure System Hardening
      community.routeros.command:
        commands:
          - /ip service disable telnet
          - /ip service disable ftp
          - /ip service disable www
          - /ip service set api disabled=yes
          - /ip service set api-ssl disabled=yes
          - /ip service set winbox address=192.168.88.0/24
          - /user set admin password="\$(cat /dev/urandom | tr -dc 'A-Za-z0-9!@#$%^&*()' | head -c 16)"
          - /system logging action set memory memory-lines=500
          - /system logging add topics=firewall,info action=memory
          - /ip socks set enabled=no
          - /ip proxy set enabled=no
          - /tool bandwidth-server set enabled=no

EOF
}

add_route_task() {
    cat >> "$TASKS_FILE" << EOF
    - name: Add Static Route to ${CONFIG[ROUTE_DEST]}
      community.routeros.command:
        commands:
          - /ip route add dst-address=${CONFIG[ROUTE_DEST]} gateway=${CONFIG[ROUTE_GATEWAY]} distance=1 check-gateway=ping

EOF
}

set_ntp_task() {
    cat >> "$TASKS_FILE" << EOF
    - name: Configure NTP Client
      community.routeros.command:
        commands:
          - /system ntp client set enabled=yes primary-ntp=${CONFIG[NTP_SERVER]} secondary-ntp=time.google.com
          - /system clock set time-zone-name=Asia/Tehran

EOF
}

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')]: $1" >> ${CONFIG[IMF_CONFIG_LOG]}
}

validate_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(/[0-9]+)?$ ]] || 
       [[ $ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+-[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        return 0
    else
        return 1
    fi
}

create_yaml() {

	if [ "${CONFIG[HEADER]}" = "true" ] || [ -e ${CONFIG[HEADER]} ] || ! grep "tasks:" ${CONFIG[HEADER]} ; then
		playbook_header
		log_message "create header and yaml file task added"
	fi
	
	if [ "${CONFIG[FILECONFIG]}" = "true" ]; then
		file_config
		log_message "User file config task added"
	fi

	if [ "${CONFIG[HOSTNAME]}" = "true" ]; then
		hostname_task
		log_message "Hostname task added"
	fi

	if [ "${CONFIG[DHCP_SERVER]}" = "true" ]; then
        if validate_ip "${CONFIG[DHCP_POOL]}" && validate_ip "${CONFIG[DHCP_NETWORK]}"; then
            create_dhcp_server_task
            log_message "DHCP Server task added"
        else
            log_message "Error: Invalid DHCP IP address"
            return 1
        fi
    fi

    if [ "${CONFIG[VLAN]}" = "true" ]; then
        if [[ "${CONFIG[VLAN_ID]}" =~ ^[0-9]+$ ]] && [ "${CONFIG[VLAN_ID]}" -ge 1 ] && [ "${CONFIG[VLAN_ID]}" -le 4094 ]; then
            create_vlan_task
            log_message "VLAN task added"
        else
            log_message "Error: Invalid VLAN ID (must be between 1 and 4094)"
            return 1
        fi
    fi

    if [ "${CONFIG[FIREWALL]}" = "true" ]; then
        create_firewall_task
        log_message "Firewall task added"
    fi

    if [ "${CONFIG[HARDEN]}" = "true" ]; then
        create_harden_task
        log_message "Hardening task added"
    fi

    if [ "${CONFIG[ADD_ROUTE]}" = "true" ]; then
        if validate_ip "${CONFIG[ROUTE_DEST]}" && validate_ip "${CONFIG[ROUTE_GATEWAY]}"; then
            create_add_route_task
            log_message "Static Route task added"
        else
            log_message "Error: Invalid Route address"
            return 1
        fi
    fi

    if [ "${CONFIG[SET_NTP]}" = "true" ]; then
        create_set_ntp_task
        log_message "NTP task added"
    fi

    log_message "Configuration file created at ${CONFIG[OUTPUT_FILE]}"
    return 0
}

arguments() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --header)
                CONFIG[HEADER]="true"
                shift
                ;;
            --file-config)
                CONFIG[FILECONFIG]="true"
                CONFIG[FILE_CONFIG]="$2"
                shift 2
                ;;
            --hostname)
                CONFIG[HOSTNAME]="true"
                CONFIG[HOST_NAME]="$2"
                shift 2
                ;;
            --dhcp-server)
                CONFIG[DHCP_SERVER]="true"
                shift
                ;;
            --dhcp-pool)
                CONFIG[DHCP_POOL]="$2"
                shift 2
                ;;
            --dhcp-network)
                CONFIG[DHCP_NETWORK]="$2"
                shift 2
                ;;
            --vlan)
                CONFIG[VLAN]="true"
                shift
                ;;
            --vlan-id)
                CONFIG[VLAN_ID]="$2"
                shift 2
                ;;
            --vlan-interface)
                CONFIG[VLAN_INTERFACE]="$2"
                shift 2
                ;;
            --firewall)
                CONFIG[FIREWALL]="true"
                shift
                ;;
            --harden)
                CONFIG[HARDEN]="true"
                shift
                ;;
            --add-route)
                CONFIG[ADD_ROUTE]="true"
                shift
                ;;
            --route-dest)
                CONFIG[ROUTE_DEST]="$2"
                shift 2
                ;;
            --route-gateway)
                CONFIG[ROUTE_GATEWAY]="$2"
                shift 2
                ;;
            --set-ntp)
                CONFIG[SET_NTP]="true"
                shift
                ;;
            --ntp-server)
                CONFIG[NTP_SERVER]="$2"
                shift 2
                ;;
            --output-file)
                CONFIG[OUTPUT_FILE]="$2"
                shift 2
                ;;
            --help)
                show_help
                ;;
            *)
                echo "argument error: not found : $1"
                show_help
                exit 1
                ;;
        esac
    done
}


main() {
    # Parse arguments
    arguments "$@"
    
    
    # Create configuration
    if create_yaml; then
        echo "‚úÖ Configuration file successfully created!"
        echo ""
        echo "üìù Usage:"
        echo "ansible-playbook -i inventory.ini ${CONFIG[OUTPUT_FILE]}"
        echo ""
        echo "üîß Sample inventory.ini:"
        cat << EOF
[mikrotik]
router.local ansible_host=192.168.88.1 ansible_user=admin ansible_password=admin ansible_connection=ansible.netcommon.network_cli

[all:vars]
ansible_network_os=community.routeros.routeros
EOF
        echo ""
        echo "‚ö†Ô∏è  Notes:"
        echo "  - Change admin password in inventory before execution"
        echo "  - Adjust IP address to match your actual router"
        echo "  - Ensure community.routeros collection is installed"
    else
        echo "‚ùå Error creating configuration file"
        exit 1
    fi
}


if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    if [ $# -eq 0 ]; then
        show_help
    else
        main "$@"
    fi
fi
